name: Build ICU

on:
  workflow_dispatch:
    inputs:
      icu_version:
        description: 'ICU version (e.g., 78.1)'
        required: true
        default: '78.1'

jobs:
  build:
    name: Build ICU ${{ github.event.inputs.icu_version }} for ${{ matrix.os }}-${{ matrix.arch }}

    strategy:
      fail-fast: false
      matrix:
        include:
        - os: linux
          arch: aarch64
        - os: linux
          arch: i686
        - os: linux
          arch: x86_64
        - os: linux-musl
          arch: aarch64
        - os: linux-musl
          arch: i686
        - os: linux-musl
          arch: x86_64
        - os: macos
          arch: arm64
        - os: macos
          arch: x86_64
        - os: windows
          arch: AMD64
        - os: windows
          arch: x86
        - os: windows
          arch: ARM64

    runs-on:
      ${{
        (matrix.os == 'linux' && 'ubuntu-24.04')
        || (matrix.os == 'linux-musl' && 'ubuntu-24.04')
        || (matrix.os == 'macos' && matrix.arch == 'arm64' && 'macos-15')
        || (matrix.os == 'macos' && matrix.arch == 'x86_64' && 'macos-15-intel')
        || (matrix.os == 'windows' && 'windows-2022')
        || 'unknown'
      }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: startsWith(matrix.os, 'linux') && matrix.arch != 'x86_64'
        with:
          platforms: all

      - name: Get Docker image from cibuildwheel
        if: startsWith(matrix.os, 'linux')
        run: |
          pip install cibuildwheel==3.3.1
          IMAGE=$(python -c "
          from cibuildwheel.options import _get_pinned_container_images
          config = _get_pinned_container_images()
          arch = '${{ matrix.arch }}'
          if '${{ matrix.os }}' == 'linux':
              platform = 'manylinux_2_28'
          else:
              platform = 'musllinux_1_2'
          print(config[arch][platform])
          ")
          echo "DOCKER_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Build ICU (Linux glibc)
        if: matrix.os == 'linux'
        run: |
          docker run --rm -v $PWD:/work -w /work \
            --platform linux/${{ matrix.arch == 'x86_64' && 'amd64' || matrix.arch == 'i686' && '386' || 'arm64' }} \
            ${{ env.DOCKER_IMAGE }} \
            python3 build.py --version ${{ github.event.inputs.icu_version }} --platform linux --arch ${{ matrix.arch }}

      - name: Build ICU (Linux musl)
        if: matrix.os == 'linux-musl'
        run: |
          docker run --rm -v $PWD:/work -w /work \
            --platform linux/${{ matrix.arch == 'x86_64' && 'amd64' || matrix.arch == 'i686' && '386' || 'arm64' }} \
            ${{ env.DOCKER_IMAGE }} \
            python3 build.py --version ${{ github.event.inputs.icu_version }} --platform linux-musl --arch ${{ matrix.arch }}

      - name: Build ICU (macOS)
        if: matrix.os == 'macos'
        run: |
          python3 build.py --version ${{ github.event.inputs.icu_version }} --platform macos --arch ${{ matrix.arch }}

      - name: Build ICU (Windows)
        if: matrix.os == 'windows'
        run: |
          python build.py --version ${{ github.event.inputs.icu_version }} --platform windows --arch ${{ matrix.arch }}

      - run: ls -lh dist/
        if: matrix.os != 'windows'

      - run: dir dist/
        if: matrix.os == 'windows'

      - uses: actions/upload-artifact@v6
        with:
          name: icu-${{ github.event.inputs.icu_version }}-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*.tar.gz

  release:
    needs: build
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
          pattern: icu-*
          merge-multiple: true

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.event.inputs.icu_version }} \
            --title "ICU ${{ github.event.inputs.icu_version }}" \
            --notes "Pre-built ICU ${{ github.event.inputs.icu_version }} libraries for multiple platforms" \
            dist/*.tar.gz
